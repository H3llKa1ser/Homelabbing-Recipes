# ──────────────────────────────────────────────
# HTTPS Redirector → C2 Backend
# ──────────────────────────────────────────────
server {
    listen 80;
    server_name {{ redirect_domain }};

    # Redirect HTTP → HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name {{ redirect_domain }};

{% if redirect_domain | length > 0 %}
    ssl_certificate     /etc/letsencrypt/live/{{ redirect_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{ redirect_domain }}/privkey.pem;
{% endif %}

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ── Malleable C2 URI paths ──
    # Customize these to match your C2 profile
    location ~* ^/(api/v1|updates|static|content)/ {
        proxy_pass         https://{{ c2_internal_ip }}:{{ c2_https_port }};
        proxy_ssl_verify   off;
        proxy_set_header   Host $host;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Real-IP $remote_addr;
    }

    # ── Default: serve a decoy page ──
    location / {
        # Return a benign-looking page for scanners / blue team
        return 200 '<!DOCTYPE html><html><head><title>Welcome</title></head><body><h1>Under Maintenance</h1></body></html>';
        add_header Content-Type text/html;
    }

    # Block common scanners / unwanted user-agents
    if ($http_user_agent ~* (nmap|nikto|sqlmap|masscan|zgrab|censys)) {
        return 444;
    }

    access_log /var/log/redteam/redirector-access.log;
    error_log  /var/log/redteam/redirector-error.log;
}
